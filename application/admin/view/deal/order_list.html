{extend name='main'}

{block name="content"}
<style>
    ::-webkit-scrollbar {
        height: 8px;
    }
</style>
<div class="think-box-shadow">
    {include file='deal/order_list_search'}
    <?php
        $level = Db::table('xy_level')->field('name,level')->select();
        $levelname = array_column($level, 'name','level');
    ?>
    <fieldset>
        <legend>数据统计</legend>
        <font color="red">交易总额：{$order_sum}元</font> &nbsp;&nbsp;&nbsp;<font color="red">佣金总额：{$commission_sum}元</font>
    </fieldset>
    <table class="layui-table margin-top-15" lay-skin="line">
        {notempty name='list'}
        <thead>
            <tr>
                <th class='list-table-check-td think-checkbox'>
                    <input data-auto-none data-check-target='.list-check-box' type='checkbox'>
                </th>
                <th class='text-left nowrap'>订单号</th>
                <th class='text-left nowrap'>真实姓名</th>
                <th class='text-left nowrap'>会员等级</th>
                <th class='text-left nowrap'>余额</th>
                <th class='text-left nowrap'>今日单数</th>
                <th class='text-left nowrap'>单价数量</th>
                <th class='text-left nowrap'>总价佣金</th>
                <th class='text-left nowrap'>下单时间 解冻时间</th>
                <th class='text-left nowrap'>交易状态</th>
                <th class='text-left nowrap'>物品质量</th>
                <th class='text-left nowrap'>物品服务</th>
                <th class='text-left nowrap'>态度服务</th>
                <th class='text-left nowrap'>传买家秀</th>
                <th class='text-left nowrap'>操作</th>
                <th class='text-left nowrap'>商品名称</th>
            </tr>
        </thead>
        {/notempty}
        <tbody>
            {foreach $list as $key=>$vo}
            <tr>
                <td class='list-table-check-td think-checkbox'>
                    <input class="list-check-box" value='{$vo.id}' type='checkbox'>
                </td>
                <td class='text-left nowrap J_id'>{$vo.id}</td>
                <td class='text-left nowrap'>{$vo.username}</td>
                <td class='text-left nowrap'>{:model('Users')->getLevel($vo.level,'name');}</td>
                <td class='text-left nowrap'>{$vo.ubalance}</td>
                <td class='text-left nowrap '> {$vo.addtime|format_datetime='m-d'} <p class="J_today_num">排序</p>
                </td>
                <td class='text-left nowrap'>单价&nbsp;${$vo.goods_price}<p>数量:&nbsp; {$vo.goods_count}</td>
                <td class='text-left nowrap'>
                    <font color="red">总价&nbsp;${$vo.num}</font>
                    <p>佣金&nbsp;${$vo.commission}
                </td>
                <td class='text-left nowrap'>
                    {$vo.addtime|format_datetime}<p>{$vo.endtime|format_datetime}

                </td>
                <td class='text-left nowrap'>{$vo.good_quality} </td>
                <td class='text-left nowrap'>{$vo.good_service} </td>
                <td class='text-left nowrap'>{$vo.attitude_service} </td>
                <td class='text-left nowrap'>
                    <a data-title="查看图片" data-modal='{:url("admin/users/picinfo")}?pic={$vo.buyer_show_img}'>
                        <img src="{$vo.buyer_show_img}" style="width:150px;height:100px;">
                    </a>
                </td>
                <td class='text-left nowrap' style="color: red;">
                    {switch $vo.status}
                    {case 0}
                    {literal}
                    等待付款
                    {/literal}
                    {/case}
                    {case 1}已付款{/case}
                    {case 2}待发货{/case}
                    {case 3}已发货{/case}
                    {case 4}待收货{/case}
                    {case 5}已收货{/case}
                    {case 6}待评价{/case}
                    {case 7}评价完成{/case}
                    {/switch}
                </td>
                <td class='text-left nowrap'>
                    <a href="/admin/deal/export_order?oid={$vo.id}" class="layui-btn layui-btn-xs">导出</a>
                    {if $vo.status==2}
                    <!-- <a data-csrf="{:systoken('admin/deal/do_user_order')}" class="layui-btn layui-btn-xs layui-btn"
                        data-action="{:url('do_user_order')}" data-value="id#{$vo.id};status#4">发货</a> -->
                    <!-- <a data-csrf="{:systoken('admin/deal/do_user_order')}" class="layui-btn layui-btn-xs layui-btn-warm"
                        data-action="{:url('do_user_order')}" data-value="id#{$vo.id};status#4">取消订单</a> -->
                    <a data-dbclick class="layui-btn layui-btn-xs" data-title="发货"
                        data-modal='{:url("admin/deal/shipping")}?id={$vo.id}'>发货</a>
                    {/if}
                </td>
                <td class='text-left nowrap'>{$vo.goods_name} </td>
            </tr>
            {/foreach}
        </tbody>
    </table>

    {empty name='list'}<span class="notdata">没有记录哦</span>{else}{$pagehtml|raw|default=''}{/empty}

</div>

<script type="text/javascript" charset="utf-8">
    $(function () {
        $(".J_id").each(function () {
            var id = $(this).text();
            console.log(id);
            var _this = $(this);
            $.ajax({
                dataType: "json",
                type: "POST",
                // async: false,
                url: "/admin/deal/get_order_info",
                data: { id: id, time: new Date().getTime() },
                success: function (data) {
                    console.log(data);
                    if (data.code == 1) {
                        //  _this.parent().find(".J_today_num").html(data.date + ' 第' + data.today_num + '单');
                        _this.parent().find(".J_today_num").html(' 第' + data.today_num + '单');
                        _this.parent().find(".J_parent_username").html(data.parent_username);
                    }
                },
                error: function (XMLHttpRequest, textStatus, errorThrown) {
                    console.log("ajax error");
                },
                complete: function (XMLHttpRequest, textStatus) {
                    this; // 调用本次AJAX请求时传递的options参数
                }
            });
        });
    });
</script>
{/block}