<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <meta name="viewport"
        content="width=device-width,user-scalable=no,initial-scale=1,maximum-scale=1,minimum-scale=1" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta content="telephone=yes" name="format-detection" />
    <meta name="apple-mobile-web-app-status-bar-style" content="white" />
    <meta name="x5-fullscreen" content="true" />
    <meta name="apple-touch-fullscreen" content="yes" />
    <title>{:lang('我的')}</title>
    <link rel="stylesheet" href="/statics/css/global.css" />
    <link rel="stylesheet" href="/web/css/personal_information.css" />
    <link rel="stylesheet" href="/static_new/css/public.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons+Outlined">
    <script charset="utf-8" src="/static_new/js/jquery.min.js"></script>
    <script charset="utf-8" src="/static_new/js/dialog.min.js"></script>
</head>

<body>
    <div id="app">
        <div class="personal-header">
            <i class="material-icons-outlined" style="margin-right: 10px; cursor: pointer;" onclick="goBack()">
                arrow_back
            </i>
            Personal information
        </div>
        <div class="personal-container">
            <div class="user-avatar">
                <div class="user-avatar-container">
                    <img src="{if $user.headpic}{$user.headpic}{else/}/web/img/USER_item.png{/if}" width="64"
                        height="64" style="border-radius: 32px;" id="user_avatar">
                    <input type="file" id="fileInput" style="display: none;" />
                    <input type="hidden" value="" id="avatar_url" />
                    <div class="user-avatar-edit" id="uploadArea">
                        <i class="material-icons-outlined color-white" style="font-size: 16px;">
                            edit
                        </i>
                    </div>
                </div>
            </div>
            <div class="personal-information">
                <!-- <div class="text-18 color-2B2B2B text-center font-800">Delivery address</div> -->
                <div class="user-name-input-form">
                    <i class="material-icons-outlined">person</i>
                    <input class="user-name-input" type="text" name="name" placeholder="Name" value="{$user.username}"/>
                </div>
                <div class="user-tel-input-form">
                    <i class="material-icons-outlined">phone_in_talk</i>
                    <input class="user-tel-input" type="text" name="tel" placeholder="Mobile phone number" value="{$user.tel}"/>
                </div>
                <div class="user-address-input-form">
                    <i class="material-icons-outlined">location_on</i>
                    <input class="user-address-input" type="text" name="address" placeholder="Address" value="{$user.address}"/>
                </div>
                <div class="user-password-input-form">
                    <i class="material-icons-outlined">lock</i>
                    <input class="user-password-input" type="password" name="pwd" placeholder="Password" />
                    <i class="material-icons-outlined password-icon-eye" style="cursor: pointer;">visibility</i>
                </div>
                <div class="payment-password-input-form">
                    <i class="material-icons-outlined">payments</i>
                    <input class="payment-password-input" type="password" name="pwd2" placeholder="Payment password" />
                    <i class="material-icons-outlined payment-icon-eye" style="cursor: pointer;">visibility</i>
                </div>
                <div class="submit-form">
                    <button class="submit-form-btn" onclick="submitPersonalInfo()">Submit</button>
                </div>
            </div>
        </div>
    </div>
</body>
<script type="application/javascript">
    var loading = null;
    function goBack() {
        window.history.go(-1);
    }
    // Get references to the elements
    const uploadArea = document.getElementById("uploadArea");
    const fileInput = document.getElementById("fileInput");

    // When clicking the upload area, trigger the file input dialog
    uploadArea.addEventListener("click", function () {
        fileInput.click();  // Open file dialog
    });

    // Display the selected file name
    fileInput.addEventListener("change", function () {
        const file = fileInput.files[0];
        if (file) {
            uploadFile(file);
        }
    });

    // Function to upload file using AJAX
    function uploadFile(file) {
        // Create FormData object to send the file data
        const formData = new FormData();
        formData.append('file', file);
        // Perform AJAX request
        $.ajax({
            url: '/index/my/upload',  // Replace with your server upload URL
            type: 'POST',
            data: formData,
            contentType: false,
            processData: false,
            success: function (response) {
                console.log(response);
                $("#user_avatar").attr('src', response.url).show();
                $("#avatar_url").val(response.url);
            },
            error: function (jqXHR, textStatus, errorThrown) {
            }
        });
    }
    /*显示or隐藏密码*/
    $(".password-icon-eye").on('click', function () {
        var input = $("input[name=pwd]");
        var icon = $(this);

        // Toggle the input type between password and text
        if (input.attr("type") === 'password') {
            input.attr('type', 'text');
            icon.text('visibility_off'); // Change the icon to "visibility_off"
        } else {
            input.attr('type', 'password');
            icon.text('visibility'); // Change the icon back to "visibility"
        }
    });
    /*显示or隐藏密码*/
    $(".payment-icon-eye").on('click', function () {
        var input = $("input[name=pwd2]");
        var icon = $(this);

        // Toggle the input type between password and text
        if (input.attr("type") === 'password') {
            input.attr('type', 'text');
            icon.text('visibility_off'); // Change the icon to "visibility_off"
        } else {
            input.attr('type', 'password');
            icon.text('visibility'); // Change the icon back to "visibility"
        }
    });
    function submitPersonalInfo() {
        let username = $("input[name=name]").val();
        let tel = $("input[name=tel]").val();
        let address = $("input[name=address]").val();
        let pwd = $("input[name=pwd]").val();
        let pwd2 = $("input[name=pwd2]").val();
        let headpic = $("#avatar_url").val();
        $.ajax({
            url: "{:url('update_personal_info')}",
            type: 'POST',
            dataType: "JSON",
            data: { username: username, tel:tel, address: address, pwd: pwd, pwd2: pwd2, headpic: headpic},
            beforeSend: function () {
                loading = $(document).dialog({
                    type: 'notice',
                    infoIcon: '/static_new/img/loading.gif',
                    infoText: "{:lang('loading...')}",
                    autoClose: 0
                });
            },
            success: function (data) {
                loading.close();
                if (data.code == 0) {
                    $(document).dialog({ infoText: "{:lang('Successfully updated!')}" });
                    setTimeout(function () {
                        location.href = "{:url('my/index')}"
                    }, 3000);
                } else {
                    $(document).dialog({ infoText: data.info });
                    setTimeout(function () {
                        location.reload();
                    }, 2000);
                }
            }
        });

    }
</script>

</html>